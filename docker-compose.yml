services:
  # Service principal : Backend PHP + Python
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: archimeuble-backend
    ports:
      - "8000:8000"
    volumes:
      # Monter le code source du backend (hot reload en développement)
      - .:/app
      # Monter le dossier models du frontend
      - ../front/public/models:/app/models
      # Persister la base de données ← NOUVEAU
      - ./database:/app/database
    environment:
      - TZ=Europe/Paris
      - DB_PATH=/app/database/archimeuble.db
      - PYTHON_PATH=/opt/venv/bin/python3
      - FRONTEND_URL=http://localhost:3000
      - OUTPUT_DIR=/app/models
      # Configuration SMTP pour l'envoi d'emails
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_USERNAME=${SMTP_USERNAME}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
      - SMTP_FROM_EMAIL=${SMTP_FROM_EMAIL}
      - SMTP_FROM_NAME=${SMTP_FROM_NAME}
      - ADMIN_EMAIL=${ADMIN_EMAIL}
      # Calendly API Token
      - CALENDLY_API_TOKEN=${CALENDLY_API_TOKEN}
      # Calendly URLs publiques
      - CALENDLY_PHONE_URL=${CALENDLY_PHONE_URL}
      - CALENDLY_VISIO_URL=${CALENDLY_VISIO_URL}
      # Crisp Chat Widget ID
      - CRISP_WEBSITE_ID=${CRISP_WEBSITE_ID}
      # Twilio SMS Configuration
      - TWILIO_ACCOUNT_SID=${TWILIO_ACCOUNT_SID}
      - TWILIO_AUTH_TOKEN=${TWILIO_AUTH_TOKEN}
      - TWILIO_PHONE_NUMBER=${TWILIO_PHONE_NUMBER}
      # Cron Secret Token
      - CRON_SECRET=${CRON_SECRET}
      # Stripe Payment Configuration
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - STRIPE_PUBLISHABLE_KEY=${STRIPE_PUBLISHABLE_KEY}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}
      # Resend Email API
      - RESEND_API_KEY=${RESEND_API_KEY}
    working_dir: /app
    # Force running the init script with bash to avoid CRLF/shebang issues on Windows
    # Convertir les fins de ligne CRLF en LF (important sur Windows), installer les dépendances, initialiser la BDD, puis lancer le serveur
    command: /bin/bash -lc "sed -i 's/\r$//' /app/install_dependencies.sh && chmod +x /app/install_dependencies.sh && bash /app/install_dependencies.sh && bash /usr/local/bin/init_db.sh && php -d upload_max_filesize=20M -d post_max_size=20M -S 0.0.0.0:8000 router.php"
    networks:
      - archimeuble-network
    restart: unless-stopped

  # Service d'initialisation de la base de données (optionnel, à lancer une fois)
  db-init:
    image: nouchka/sqlite3:latest
    container_name: archimeuble-db-init
    volumes:
      - ./database:/db  # ← CORRIGÉ (était ../database)
    command: sh -c "cd /db && if [ ! -f archimeuble.db ]; then sqlite3 archimeuble.db < init_db.sql && echo '✓ Database initialized'; else echo '✓ Database already exists'; fi"
    networks:
      - archimeuble-network
    profiles:
      - init  # Ce service ne démarre qu'avec: docker compose --profile init up

networks:
  archimeuble-network:
    driver: bridge