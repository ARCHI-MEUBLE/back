services:
  # Service PostgreSQL
  postgres:
    image: postgres:16-alpine
    container_name: archimeuble-postgres
    environment:
      POSTGRES_DB: archimeuble
      POSTGRES_USER: archimeuble
      POSTGRES_PASSWORD: archimeuble_dev
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    networks:
      - archimeuble-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U archimeuble -d archimeuble"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Service principal : Backend PHP + Python
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: archimeuble-backend
    ports:
      - "8000:8000"
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      # Monter le code source du backend (hot reload en développement)
      - .:/app
      # Monter le dossier models du frontend
      - ../front/public/models:/app/models
    environment:
      - TZ=Europe/Paris
      - DATABASE_URL=postgresql://archimeuble:archimeuble_dev@postgres:5432/archimeuble
      - PYTHON_PATH=/opt/venv/bin/python3
      - FRONTEND_URL=http://localhost:3000
      - OUTPUT_DIR=/app/models
      # Configuration SMTP pour l'envoi d'emails
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_USERNAME=${SMTP_USERNAME}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
      - SMTP_FROM_EMAIL=${SMTP_FROM_EMAIL}
      - SMTP_FROM_NAME=${SMTP_FROM_NAME}
      - ADMIN_EMAIL=${ADMIN_EMAIL}
      # Calendly API Token
      - CALENDLY_API_TOKEN=${CALENDLY_API_TOKEN}
      # Calendly URLs publiques
      - CALENDLY_PHONE_URL=${CALENDLY_PHONE_URL}
      - CALENDLY_VISIO_URL=${CALENDLY_VISIO_URL}
      # Crisp Chat Widget ID
      - CRISP_WEBSITE_ID=${CRISP_WEBSITE_ID}
      # Twilio SMS Configuration
      - TWILIO_ACCOUNT_SID=${TWILIO_ACCOUNT_SID}
      - TWILIO_AUTH_TOKEN=${TWILIO_AUTH_TOKEN}
      - TWILIO_PHONE_NUMBER=${TWILIO_PHONE_NUMBER}
      # Cron Secret Token
      - CRON_SECRET=${CRON_SECRET}
      # Stripe Payment Configuration
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - STRIPE_PUBLISHABLE_KEY=${STRIPE_PUBLISHABLE_KEY}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}
      # Resend Email API
      - RESEND_API_KEY=${RESEND_API_KEY}
    working_dir: /app
    command: /bin/bash -c "export PATH=/opt/venv/bin:$$PATH && bash /app/install_dependencies.sh && bash /app/start.sh"
    networks:
      - archimeuble-network
    restart: unless-stopped

  # Interface web pour voir la base de données (localhost:8080)
  adminer:
    image: adminer:latest
    container_name: archimeuble-adminer
    ports:
      - "8080:8080"
    depends_on:
      - postgres
    networks:
      - archimeuble-network
    restart: unless-stopped

networks:
  archimeuble-network:
    driver: bridge

volumes:
  pgdata: